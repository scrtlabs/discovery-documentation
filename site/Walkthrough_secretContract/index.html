



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.0">
    
    
      
        <title>Write a Secret Contract - Enigma Protocol</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="pink">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#writing-a-secret-contract" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Enigma Protocol" class="md-header-nav__button md-logo">
          
            <img src="../images/enigmawhite.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Enigma Protocol
            </span>
            <span class="md-header-nav__topic">
              Write a Secret Contract
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Enigma Protocol" class="md-nav__button md-logo">
      
        <img src="../images/enigmawhite.png" width="48" height="48">
      
    </a>
    Enigma Protocol
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="About Enigma" class="md-nav__link">
      About Enigma
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../NewForDiscovery/" title="About Discovery" class="md-nav__link">
      About Discovery
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Walkthrough/" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      EnigmaJS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        EnigmaJS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../IntroductionToEnigmaJS/" title="About EnigmaJS" class="md-nav__link">
      About EnigmaJS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../API/" title="API" class="md-nav__link">
      API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Secret Contracts
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Secret Contracts
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../SecretContracts/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../SecretContractExamples/" title="Examples" class="md-nav__link">
      Examples
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../RustWalkthrough/" title="Learn Rust" class="md-nav__link">
      Learn Rust
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../NetworkSetup/" title="Deploy Discovery" class="md-nav__link">
      Deploy Discovery
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Write a Secret Contract
      </label>
    
    <a href="./" title="Write a Secret Contract" class="md-nav__link md-nav__link--active">
      Write a Secret Contract
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setting-up-project-structure" title="Setting Up Project Structure" class="md-nav__link">
    Setting Up Project Structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-the-secret-contract" title="Writing the Secret Contract" class="md-nav__link">
    Writing the Secret Contract
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../FAQ/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../IntroductionToReference/" title="Enigma Components" class="md-nav__link">
      Enigma Components
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EnigmaOverview/" title="Enigma Technical Overview" class="md-nav__link">
      Enigma Technical Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../SecretContractEngine/" title="Secret Contract Engine" class="md-nav__link">
      Secret Contract Engine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../KeyManagement/" title="Key Management" class="md-nav__link">
      Key Management
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Glossary/" title="Glossary" class="md-nav__link">
      Glossary
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setting-up-project-structure" title="Setting Up Project Structure" class="md-nav__link">
    Setting Up Project Structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-the-secret-contract" title="Writing the Secret Contract" class="md-nav__link">
    Writing the Secret Contract
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="writing-a-secret-contract">Writing a secret contract</h1>
<p>This walkthrough will take you through the process of initializing a project, creating a secret contract, and writing unit-tests for this contract. </p>
<h3 id="setting-up-project-structure">Setting Up Project Structure</h3>
<p>Start the network with <code>discovery start</code>
This should only take 15–20 seconds (unless it is your first time, in which case it may take 3–4 minutes).</p>
<p>Create a brand new Rust library containing our secret contract logic with the following command:
<code>cargo new secret_contracts/millionaires_problem --lib</code></p>
<p>Copy and paste the contents of the <code>secret_contracts/Cargo.toml.template</code>file into the <code>Cargo.toml</code> file inside the library of <code>secret_contracts/millionaires_problem</code> that we created in step 2. </p>
<p>Under <code>[dependencies]</code> add this line: <code>serde = “1.0.84”</code>.</p>
<p>The full <code>Cargo.toml</code> file should now read:</p>
<pre><code>[package]
    name = "contract"  
   version = "0.1.0"  
   [dependencies]  
   eng-wasm = { git = "https://github.com/enigmampc/enigma-core.git", branch = "develop" }  
   eng-wasm-derive = { git = "https://github.com/enigmampc/enigma-core.git", branch = "develop" }  
   serde = "1.0.84"  
   [lib]  
   crate-type = ["cdylib"]  
   [profile.release]  
   panic = "abort"  
   lto = true  
   opt-level = "z"
</code></pre>
<h3 id="writing-the-secret-contract">Writing the Secret Contract</h3>
<p>Open the <code>lib.rs</code> file located at <code>secret_contracts/millionaires_problem/src/lib.rs</code></p>
<p>Delete existing file contents.  Add the following code.</p>
<pre><code>`
// Built-In Attributes
#![no_std]
`
All of our secret contracts exactly like this, because the SGX environment does not support all the features of Rust's standard library.  [This attribute](https://medium.com/r/?url=http%3A%2F%2Frust%20import)  removes the standard library from our program’s prelude accordingly.

Now add:
```
// Imports
extern crate eng_wasm;
extern crate eng_wasm_derive;
extern crate serde;
``
use eng_wasm::*;
use eng_wasm_derive::pub_interface;
use serde::{Serialize, Deserialize};
```
</code></pre>
<p>This brings the following packages into scope:</p>
<ul>
<li><code>eng_wasm</code> — This crate allows us to use the Enigma runtime, offering important functionalities including reading from state, writing to state, and printing.</li>
<li><code>eng_wasm_derive</code> — This crate provides functions exposed by the contract that can be called from the Enigma network and the ability to call functions of Ethereum contracts from a secret contract.</li>
<li><code>eng_wasm_derive::pub_interface</code> — Gives us the ability to add the  <code>#[pub_interface]</code>  trait to any public-facing functions within our secret contract. </li>
<li><code>serde::{Serialize, Deserialize}</code> — Allows us to serialize and deserialize custom struct types.</li>
</ul>
<p>Next add:
    <code>// Encrypted state keys
    static MILLIONAIRES: &amp;str = "millionaires";</code>
Secret contracts can maintain encrypted state. Our contract needs to maintain a list of millionaires in state, which must have an entry <code>&lt;key, value&gt;</code> pair that looks something like this: <code>&lt;"millionaires", &lt;vector of Millionaire structs&gt;&gt;</code>. As shown, <code>"millionaires"</code> is the key into this encrypted state maintaining the list of millionaires.</p>
<p>Below the state keys, add:</p>
<pre><code>~~~
// Structs
#[derive(Serialize, Deserialize)]
pub struct Millionaire {
address: H160,
net_worth: U256,
}
~~~
</code></pre>
<p>A millionaire’s metadata consists the following attributes: 
    1. ETH <code>address</code> 
    2.  <code>net_worth</code></p>
<p>Note the variable types.  <code>address</code> is of type <code>H160</code>, which corresponds to a 160-bit/20-byte hash value (recall that ETH addresses are 20 bytes long) and <code>net_worth</code> is of type <code>U256</code>, which corresponds to a 256-bit/32-byte value. 
    <em>(For those of you with Solidity backgrounds, you can think of these as <code>address</code>and <code>uint256</code> types, respectively.)</em></p>
<p>Now add:
    <code>// Public struct Contract which will consist of private and public- facing secret contract functions
    pub struct Contract;</code>
    This initializes a public struct called <code>Contract</code> which can consist of both private and public-facing functions to be defined later.</p>
<p>Add:
    <code>// Private functions accessible only by the secret contract
    impl Contract {
        fn get_millionaires() -&gt; Vec&lt;Millionaire&gt; {
            read_state!(MILLIONAIRES).unwrap_or_default()
        }
    }</code></p>
<p>This code implements the private methods for the secret contract. <code>get_millionaires()</code> returns <code>Vec&lt;Millionaire&gt;</code>, a vector of Millionaire structs stored in state. 
<em>Note how we read from secret contract state with the macro</em> <code>read_state!(&lt;key&gt;)</code>. </p>
<p>The  <code>unwrap_or_default()</code>  <a href="https://medium.com/r/?url=https://doc.rust-lang.org/std/option/enum.Option.html#method.unwrap_or_default">method</a> returns the contained value, otherwise the default for that type.</p>
<p>Next, add:</p>
<pre><code>`
// Public trait defining public-facing secret contract functions
#[pub_interface]
pub trait ContractInterface{
    fn add_millionaire(address: H160, net_worth: U256);
    fn compute_richest() -&gt; H160;
}
`
</code></pre>
<p>This section declares the public-facing secret contract signatures by creating a public  <code>trait</code>  with the  <code>#[pub_interface]</code>  macro. </p>
<p>In this case, there is now a  <code>trait</code>  called  <code>ContractInterface</code>  and two method definitions:</p>
<ul>
<li><code>add_millionaire</code> — Add/register a new millionaire with an Ethereum address (<code>H160</code>) and net worth (<code>U256</code>)</li>
<li><code>compute_richest</code> — Computes the richest millionaire. This takes no parameters (will only read from state) and returns the richest millionaire’s address, which is of type  <code>H160</code></li>
<li><code>construct</code> — This is actually not present in this secret contract, because the contract is not initialized with any data. Therefore, it is left it out entirely, meaning it defaults to the implicit  <code>construct()</code>.</li>
</ul>
<p>Now add:</p>
<pre><code>`
// Implementation of the public-facing secret contract functions defined in the ContractInterface
// trait implementation for the Contract struct above
impl ContractInterface for Contract {
    #[no_mangle]
    fn add_millionaire(address: H160, net_worth: U256) {
        let mut millionaires = Self::get_millionaires();
    millionaires.push(Millionaire {
            address,
            net_worth,
        });
        write_state!(MILLIONAIRES =&gt; millionaires);
    }
    ``
    #[no_mangle]
    fn compute_richest() -&gt; H160 {
        match Self::get_millionaires().iter().max_by_key(|m| m.net_worth) {
            Some(millionaire) =&gt; {
                millionaire.address
            },
            None =&gt; H160::zero(),
        }
    }
}
`
</code></pre>
<p>This section implements the above-defined public-facing secret contract methods. Note the  <code>#[no_mangle]</code> <a href="%28https://medium.com/r/?url=https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html?highlight=no_mangle#calling-an-unsafe-function-or-method%29">annotation</a> above every method definition, which turns off Rust’s automatic method/function name-changing behavior.</p>
<ul>
<li><code>add_millionaire</code> — Read the secret contract state to obtain the list of Millionaire structs (using the private method  <code>get_millionaires</code>mentioned above). Push a new  <code>Millionaire</code>  struct with the fields initialized to the parameters passed into this method (<code>address</code>  and  <code>net_worth</code>).  And finally,  update/write to the secret contract state with the macro: <code>write_state!(&lt;key_1&gt; =&gt; &lt;value_1&gt;, &lt;key2 =&gt; &lt;value_2&gt;, ..., &lt;key_n&gt; =&gt; &lt;value_n&gt;)</code>.</li>
<li><code>compute_richest</code> — Obtain the list of  <code>Millionaire</code>  structs stored in contract state. Using a combination of Rust's <code>match</code>  and  <code>max_by_key</code>  functionalities, return the  <code>address</code>  associated with the millionaire with the highest  <code>net_worth</code>, otherwise return the empty address  <code>0x0</code>.</li>
<li><code>construct</code>  —As we do not need our own implementation of a secret contract constructor, this utilizes the default empty  <code>construct()</code>  definition, and thus it is left out.</li>
</ul>
<p>Next, check out our tutorial on compiling, migrating, and unit-testing this contract.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../NetworkSetup/" title="Deploy Discovery" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Deploy Discovery
              </span>
            </div>
          </a>
        
        
          <a href="../FAQ/" title="FAQ" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                FAQ
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.2ba8dec4.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>